{% extends "base.html" %}
{% load static %}
{% block head %}

{% endblock %}
{% block myblock %}

<div class="container-fluid">
    <div class="row py-5 ">
        <div class="col-md-8 mx-auto my-5">
           
            
                <div class="alert alert-danger container" id="alert" style="display: none">
                    <p id="message" class="p-0 m-0"></p>
                 </div>
                <div class="container">
                    <div class="row">
                        {% csrf_token %}
                        <div class="col-md-8">
                            <input type="text" id="amount" onchange="checkAmount()" name="amount" class="form-control" placeholder="Amount">
                        </div>
                        <button></button>
                        <div class="col-md-2">
                            <button  id="btn_submit" disabled onclick="startGame()" class="btn btn-success btn-md">Set</button>
                        </div>
                    </div>
                </div>
            
        </div>
    </div>
<div class="container">
    <ul  class="list-group" id="game_lists">
                
        <li  class="list-group-item" >
            <div style="float: left;width: 65%;">
            urer have set a Challenge for  <span style="background-color: antiquewhite; padding: 2px;"><b>₹150</b></span>
            </div>
            <div style="float:right;"> 
            <button class="btn btn-primary btn-sm">Play </button>
            </div>
        </li>
        
    </ul>
    <ul  class="list-group">
        
        
    </ul>
    </div>


</div>
{% if status %}
<script>
    alert("{{status}}");
    window.location = "/"
</script>
{% endif %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.0/axios.min.js" integrity="sha512-DZqqY3PiOvTP9HkjIWgjO6ouCbq+dxqWoJZ/Q+zPYNHmlnI2dQnbJ5bxAHpAMw+LXRm4D72EIRXzvcHQtE8/VQ==" crossorigin="anonymous"></script>

 <!-- The core Firebase JS SDK is always required and must be listed first -->
 <script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-app.js"></script>
 <script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-database.js"></script>
 <!-- TODO: Add SDKs for Firebase products that you want to use
    https://firebase.google.com/docs/web/setup#available-libraries -->
 <script src="https://www.gstatic.com/firebasejs/8.1.2/firebase-analytics.js"></script>


   

<script>
    

    function checkAgain() {
        if (confirm("Are you sure?")) {
            console.log('confirmed')
            form.submit();
        } else {
            console.log('not confirmed')
        }
    }

    function startGame(){
        
        var amount = document.getElementById('amount').value;
        var alert = document.getElementById('alert')
        var message = document.getElementById('message')
        var btn_submit = document.getElementById('btn_submit')

        var data = {
            'coins' : amount
        }

        axios.post('/create_game' , data)
        .then(res =>{
            if(res.data.status == false){
                message.innerHTML = res.data.message
                alert.style.display = 'block'
                setTimeout(()=>{
                    alert.style.display = 'none'
                },3000)
            }else{
               var room_id = res.data.room_id
               window.location.href  = `/waiting_room/${room_id}`
            
            }
        })

    }


    function checkAmount() {
        var amount = document.getElementById('amount').value;
        var alert = document.getElementById('alert')
        var message = document.getElementById('message')
        var btn_submit = document.getElementById('btn_submit')
        if (amount < 50) {
            message.innerHTML = "Amount must be greater than 50"
            alert.style.display = 'block'
            btn_submit.disabled = true

        } else if (amount % 50 != 0) {
            message.innerHTML = "Amount must be a multiple of 50 eg. 50,100,150.."
            alert.style.display = 'block'
            btn_submit.disabled = true
        } else {
            alert.style.display = 'none'
            btn_submit.disabled = false
        }
    }



    function getGames(){
       var url = '/api/games?user_id={{request.user.id}}'
       var game_lists = document.getElementById('game_lists')
        axios.get(url).then(res =>{
        var html = ''
        res = res.data
        
        for(var i = 0; i < res.length; i++){
        var list_html =`<li  class="list-group-item" >
            <div style="float: left;width: 65%;">
            ${res[i].game_created_by} have set a Challenge for  <span style="background-color: antiquewhite; padding: 2px;"><b>₹${res[i].game_amount}</b></span>
            </div>
            <div style="float:right;"> 
            <button  id="${res[i].game_slug}" onclick="checkPlay('${res[i].game_slug}')" data-amount='${res[i].game_amount}' class="btn btn-primary btn-sm">Play </button>
            </div>
            </li>`
            html += list_html
        }
    
        game_lists.innerHTML = html
            
        })
    }



    function checkPlay(id){
        var current_coint = '{{coins}}' 
        var button = document.getElementById(id)

        if(current_coint < button.dataset.amount){
            button.className = 'btn btn-danger btn-sm'
            button.textContent = 'Not enough amount'
        }else{
            button.className = 'btn btn-success btn-sm'
            button.textContent = 'Game Starting'
            axios.get(`/api/mark_game_waiting/${id}`)
            .then(res =>{
                if(res.data.status == true){
                    window.location.href  = `/waiting_room/${id}`
                }
            })

        }
        
        console.log(button.dataset.amount)

    }

   
    setInterval(()=>{
        getGames()
    }, 2000)



</script>

{% endblock %}